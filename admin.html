<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - O Esquim√≥</title>
    <!-- Corrigindo o carregamento das fontes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #27ae60;
            --warning: #e67e22;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        .login-form {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .login-message {
            margin-top: 15px;
            color: var(--danger);
            text-align: center;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        .admin-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: var(--secondary);
            color: white;
            padding: 20px 0;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            margin-top: 20px;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .card-icon.primary {
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary);
        }
        
        .card-icon.success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--accent);
        }
        
        .card-icon.warning {
            background: rgba(230, 126, 34, 0.1);
            color: var(--warning);
        }
        
        .card-icon.danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        .card-title {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary);
        }
        
        .table-container {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light);
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--secondary);
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status.pending {
            background: rgba(230, 126, 34, 0.1);
            color: var(--warning);
        }
        
        .status.confirmed {
            background: rgba(39, 174, 96, 0.1);
            color: var(--accent);
        }
        
        .status.canceled {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }
        
        .btn-view {
            background: var(--primary);
            color: white;
        }
        
        .btn-edit {
            background: var(--accent);
            color: white;
        }
        
        .btn-delete {
            background: var(--danger);
            color: white;
        }
        
        .form-container {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--radius);
            color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }
        
        .notification.success {
            background: var(--accent);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .btn-success {
            background: var(--accent);
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background: #dfe6e9;
        }
        
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 10px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
    <!-- Firebase SDK (vers√£o compat√≠vel) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-form">
            <h2><i class="fas fa-snowflake"></i> Painel Administrativo</h2>
            <div class="form-group">
                <label for="login-email">E-mail</label>
                <input type="email" id="login-email" placeholder="seu@email.com">
            </div>
            <div class="form-group">
                <label for="login-password">Senha</label>
                <input type="password" id="login-password" placeholder="Sua senha">
            </div>
            <button id="btn-login" class="btn btn-primary">Entrar</button>
            <p id="login-message" class="login-message"></p>
        </div>
    </div>

    <!-- Admin Panel (inicialmente oculto) -->
    <div id="admin-panel" class="admin-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-snowflake"></i> O Esquim√≥</h1>
                <p>Painel Administrativo</p>
            </div>
            
            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#servicos"><i class="fas fa-concierge-bell"></i> Servi√ßos</a></li>
                <li><a href="#agendamentos"><i class="fas fa-calendar-alt"></i> Agendamentos</a></li>
                <li><a href="#configuracoes"><i class="fas fa-cog"></i> Configura√ß√µes</a></li>
                <li><a href="#sair" id="btn-logout"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2>Dashboard</h2>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div>
                        <div id="user-name">Administrador</div>
                        <small id="user-email">admin@oesquimo.com</small>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Agendamentos Hoje</div>
                                <div class="card-value" id="stats-today">0</div>
                            </div>
                            <div class="card-icon primary">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Agendamentos Pendentes</div>
                                <div class="card-value" id="stats-pending">0</div>
                            </div>
                            <div class="card-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Total de Clientes</div>
                                <div class="card-value" id="stats-clients">0</div>
                            </div>
                            <div class="card-icon success">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Faturamento Mensal</div>
                                <div class="card-value" id="stats-revenue">R$ 0,00</div>
                            </div>
                            <div class="card-icon danger">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>√öltimos Agendamentos</h3>
                        <button class="btn btn-primary" id="btn-refresh"><i class="fas fa-sync-alt"></i> Atualizar</button>
                    </div>
                    
                    <table id="appointments-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Servi√ßo</th>
                                <th>Data</th>
                                <th>Hor√°rio</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center;">Carregando agendamentos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Servi√ßos Section -->
            <div id="servicos" class="section">
                <div class="header">
                    <h2>Gerenciamento de Servi√ßos</h2>
                    <button class="btn btn-primary" id="btn-add-service"><i class="fas fa-plus"></i> Novo Servi√ßo</button>
                </div>
                
                <div class="table-container">
                    <table id="services-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Descri√ß√£o</th>
                                <th>Pre√ßo Base</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center;">Carregando servi√ßos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="form-container hidden" id="service-form">
                    <h3 id="service-form-title">Adicionar Novo Servi√ßo</h3>
                    
                    <div class="form-group">
                        <label for="service-name">Nome do Servi√ßo</label>
                        <input type="text" id="service-name" placeholder="Ex: Instala√ß√£o de Ar Condicionado">
                    </div>
                    
                    <div class="form-group">
                        <label for="service-desc">Descri√ß√£o</label>
                        <textarea id="service-desc" placeholder="Descreva o servi√ßo"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-price">Pre√ßo Base (R$)</label>
                        <input type="number" id="service-price" placeholder="0,00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="service-icon">√çcone (Font Awesome)</label>
                        <input type="text" id="service-icon" placeholder="fas fa-tools" value="fas fa-tools">
                    </div>
                    
                    <div class="form-group">
                        <label for="service-type">Tipo de Servi√ßo</label>
                        <select id="service-type">
                            <option value="">Selecione o tipo</option>
                            <option value="with_equipment">Com equipamento</option>
                            <option value="without_equipment">Sem equipamento</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="service-requires-electrical"> Requer parte el√©trica
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-status">Status</label>
                        <select id="service-status">
                            <option value="active">Ativo</option>
                            <option value="inactive">Inativo</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="btn-cancel-service">Cancelar</button>
                        <button class="btn btn-success" id="btn-save-service">Salvar Servi√ßo</button>
                    </div>
                </div>
            </div>
            
            <!-- Agendamentos Section -->
            <div id="agendamentos" class="section">
                <div class="header">
                    <h2>Gerenciamento de Agendamentos</h2>
                    <div>
                        <select id="filter-status" style="padding: 8px; border-radius: var(--radius); margin-right: 10px;">
                            <option value="">Todos os status</option>
                            <option value="pending">Pendente</option>
                            <option value="confirmed">Confirmado</option>
                            <option value="completed">Conclu√≠do</option>
                            <option value="canceled">Cancelado</option>
                        </select>
                        <button class="btn btn-primary" id="btn-filter"><i class="fas fa-filter"></i> Filtrar</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="all-appointments-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Servi√ßo</th>
                                <th>Data</th>
                                <th>Hor√°rio</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center;">Carregando agendamentos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Configura√ß√µes Section -->
            <div id="configuracoes" class="section">
                <div class="header">
                    <h2>Configura√ß√µes do Sistema</h2>
                </div>
                
                <div class="form-container">
                    <h3>Configura√ß√µes Gerais</h3>
                    
                    <div class="form-group">
                        <label for="config-company-name">Nome da Empresa</label>
                        <input type="text" id="config-company-name" placeholder="O Esquim√≥">
                    </div>
                    
                    <div class="form-group">
                        <label for="config-whatsapp">N√∫mero do WhatsApp</label>
                        <input type="text" id="config-whatsapp" placeholder="+5581983259341">
                    </div>
                    
                    <div class="form-group">
                        <label for="config-btu-options">Op√ß√µes de BTU (separadas por v√≠rgula)</label>
                        <textarea id="config-btu-options" placeholder="9000 BTU/h, 12000 BTU/h, 18000 BTU/h"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="config-equipment-types">Tipos de Equipamento (separados por v√≠rgula)</label>
                        <textarea id="config-equipment-types" placeholder="Janela, Split Hi-Wall, Split Piso-Teto"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-success" id="btn-save-config"><i class="fas fa-save"></i> Salvar Configura√ß√µes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCFf5gckKE6rg7MFuBYAO84aV-sNrdY2JQ",
            authDomain: "agendamento-esquimo.firebaseapp.com",
            projectId: "agendamento-esquimo",
            storageBucket: "agendamento-esquimo.appspot.com",
            messagingSenderId: "348946727206",
            appId: "1:348946727206:web:f5989788f13c259be0c1e7"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Elementos da interface
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const btnLogin = document.getElementById('btn-login');
        const loginMessage = document.getElementById('login-message');
        const btnLogout = document.getElementById('btn-logout');

        // Vari√°veis globais
        let editingServiceId = null;

        // Fun√ß√£o para mostrar notifica√ß√£o
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Fun√ß√£o para verificar autentica√ß√£o
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                
                // Atualizar informa√ß√µes do usu√°rio
                document.getElementById('user-avatar').textContent = user.email.charAt(0).toUpperCase();
                document.getElementById('user-name').textContent = user.displayName || user.email;
                document.getElementById('user-email').textContent = user.email;
                
                // Carregar dados
                loadDashboardData();
                loadServices();
                loadConfig();
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        // Evento de login
        btnLogin.addEventListener('click', () => {
            const email = loginEmail.value;
            const password = loginPassword.value;
            
            if (!email || !password) {
                loginMessage.textContent = 'Por favor, preencha todos os campos.';
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showNotification('Login realizado com sucesso!');
                    loginMessage.textContent = '';
                })
                .catch((error) => {
                    loginMessage.textContent = 'E-mail ou senha inv√°lidos.';
                    console.error('Erro de login:', error);
                });
        });

        // Evento de logout
        btnLogout.addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    showNotification('Logout realizado com sucesso!');
                })
                .catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                });
        });

        // Navega√ß√£o do menu
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.id === 'btn-logout') return;
                
                e.preventDefault();
                
                // Remove a classe active de todos os links
                document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                
                // Adiciona a classe active ao link clicado
                this.classList.add('active');
                
                // Oculta todas as se√ß√µes
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                
                // Mostra a se√ß√£o correspondente
                const target = this.getAttribute('href').substring(1);
                document.getElementById(target).classList.add('active');
                
                // Atualiza o header
                document.querySelector('.header h2').textContent = this.textContent.trim();
                
                // Carrega dados espec√≠ficos da se√ß√£o
                if (target === 'agendamentos') {
                    loadAllAppointments();
                } else if (target === 'servicos') {
                    loadServices();
                } else if (target === 'dashboard') {
                    loadDashboardData();
                } else if (target === 'configuracoes') {
                    loadConfig();
                }
            });
        });

        // Carregar dados do dashboard (vers√£o simplificada para evitar erros de √≠ndice)
        async function loadDashboardData() {
            try {
                // Carregar todos os agendamentos primeiro
                const allAppointments = await db.collection('agendamentos').get();
                
                const today = new Date();
                const todayFormatted = formatDate(today);
                
                let todayCount = 0;
                let pendingCount = 0;
                const uniqueClients = new Set();
                let totalRevenue = 0;
                
                allAppointments.forEach(doc => {
                    const data = doc.data();
                    
                    // Contar agendamentos de hoje
                    if (data.data === todayFormatted) {
                        todayCount++;
                    }
                    
                    // Contar agendamentos pendentes
                    if (data.status === 'pending') {
                        pendingCount++;
                    }
                    
                    // Contar clientes √∫nicos
                    if (data.cliente && data.cliente.telefone) {
                        uniqueClients.add(data.cliente.telefone);
                    }
                    
                    // Calcular faturamento (considerando apenas confirmados e conclu√≠dos)
                    if (data.status === 'confirmed' || data.status === 'completed') {
                        totalRevenue += parseFloat(data.total) || 0;
                    }
                });
                
                document.getElementById('stats-today').textContent = todayCount;
                document.getElementById('stats-pending').textContent = pendingCount;
                document.getElementById('stats-clients').textContent = uniqueClients.size;
                document.getElementById('stats-revenue').textContent = `R$ ${totalRevenue.toFixed(2)}`;
                
                // Carregar √∫ltimos agendamentos
                loadAppointments();
                
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }

        // Formatar data para o formato dd/mm/yyyy
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Carregar agendamentos (para o dashboard)
        async function loadAppointments() {
            try {
                const appointmentsSnapshot = await db.collection('agendamentos')
                    .orderBy('data', 'desc')
                    .orderBy('horario', 'desc')
                    .limit(10)
                    .get();
                
                const tbody = document.querySelector('#appointments-table tbody');
                renderAppointmentsTable(appointmentsSnapshot, tbody);
                
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                const tbody = document.querySelector('#appointments-table tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erro ao carregar agendamentos.</td></tr>';
            }
        }

        // Carregar todos os agendamentos (para a se√ß√£o de agendamentos)
        async function loadAllAppointments() {
            try {
                let query = db.collection('agendamentos')
                    .orderBy('data', 'desc')
                    .orderBy('horario', 'desc');
                
                // Aplicar filtro de status se existir
                const statusFilter = document.getElementById('filter-status').value;
                if (statusFilter) {
                    query = query.where('status', '==', statusFilter);
                }
                
                const appointmentsSnapshot = await query.get();
                const tbody = document.querySelector('#all-appointments-table tbody');
                renderAppointmentsTable(appointmentsSnapshot, tbody);
                
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                const tbody = document.querySelector('#all-appointments-table tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erro ao carregar agendamentos.</td></tr>';
            }
        }

        // Renderizar tabela de agendamentos
        function renderAppointmentsTable(snapshot, tbody) {
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum agendamento encontrado.</td></tr>';
                return;
            }
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${data.cliente?.nome || 'N/A'}</td>
                    <td>${getServiceNames(data.servicos)}</td>
                    <td>${data.data || 'N/A'}</td>
                    <td>${data.horario || 'N/A'}</td>
                    <td>R$ ${data.total?.toFixed(2) || '0,00'}</td>
                    <td><span class="status ${data.status || 'pending'}">${getStatusText(data.status)}</span></td>
                    <td>
                        <button class="action-btn btn-view" data-id="${doc.id}"><i class="fas fa-eye"></i></button>
                        <button class="action-btn btn-edit" data-id="${doc.id}"><i class="fas fa-edit"></i></button>
                    </td>
                `;
                
                tbody.appendChild(tr);
                
                // Adicionar evento para visualizar
                tr.querySelector('.btn-view').addEventListener('click', () => {
                    viewAppointment(doc.id);
                });
                
                // Adicionar evento para editar
                tr.querySelector('.btn-edit').addEventListener('click', () => {
                    editAppointment(doc.id);
                });
            });
        }

        // Fun√ß√£o auxiliar para obter nomes dos servi√ßos
        function getServiceNames(servicos) {
            if (!servicos) return 'N/A';
            
            const names = [];
            for (const key in servicos) {
                names.push(servicos[key].nome);
            }
            
            return names.join(', ');
        }

        // Fun√ß√£o auxiliar para obter texto do status
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pendente',
                'confirmed': 'Confirmado',
                'completed': 'Conclu√≠do',
                'canceled': 'Cancelado'
            };
            
            return statusMap[status] || 'Pendente';
        }

        // Carregar servi√ßos
        async function loadServices() {
            try {
                const servicesSnapshot = await db.collection('services')
                    .orderBy('nome')
                    .get();
                
                const tbody = document.querySelector('#services-table tbody');
                renderServicesTable(servicesSnapshot, tbody);
                
            } catch (error) {
                console.error('Erro ao carregar servi√ßos:', error);
                const tbody = document.querySelector('#services-table tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erro ao carregar servi√ßos.</td></tr>';
            }
        }

        // Renderizar tabela de servi√ßos
        function renderServicesTable(snapshot, tbody) {
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum servi√ßo cadastrado.</td></tr>';
                return;
            }
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>${data.nome || 'N/A'}</td>
                    <td>${data.descricao ? (data.descricao.length > 50 ? data.descricao.substring(0, 50) + '...' : data.descricao) : 'N/A'}</td>
                    <td>R$ ${data.precoBase?.toFixed(2) || '0,00'}</td>
                    <td>${data.requerEquipamento ? 'Com equipamento' : 'Sem equipamento'}</td>
                    <td><span class="status ${data.ativo ? 'confirmed' : 'canceled'}">${data.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button class="action-btn btn-edit" data-id="${doc.id}"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                tbody.appendChild(tr);
                
                // Adicionar eventos aos bot√µes
                tr.querySelector('.btn-edit').addEventListener('click', () => {
                    editService(doc.id);
                });
                
                tr.querySelector('.btn-delete').addEventListener('click', () => {
                    deleteService(doc.id);
                });
            });
        }

        // Fun√ß√£o para resetar formul√°rio de servi√ßo
        function resetServiceForm() {
            document.getElementById('service-name').value = '';
            document.getElementById('service-desc').value = '';
            document.getElementById('service-price').value = '';
            document.getElementById('service-icon').value = 'fas fa-tools';
            document.getElementById('service-type').value = '';
            document.getElementById('service-requires-electrical').checked = false;
            document.getElementById('service-status').value = 'active';
            editingServiceId = null;
        }

        // Fun√ß√£o para editar servi√ßo
        async function editService(serviceId) {
            try {
                const serviceDoc = await db.collection('services').doc(serviceId).get();
                
                if (serviceDoc.exists) {
                    editingServiceId = serviceId;
                    const data = serviceDoc.data();
                    
                    document.getElementById('service-form-title').textContent = 'Editar Servi√ßo';
                    document.getElementById('service-form').classList.remove('hidden');
                    
                    document.getElementById('service-name').value = data.nome || '';
                    document.getElementById('service-desc').value = data.descricao || '';
                    document.getElementById('service-price').value = data.precoBase || '';
                    document.getElementById('service-icon').value = data.icone || 'fas fa-tools';
                    document.getElementById('service-type').value = data.requerEquipamento ? 'with_equipment' : 'without_equipment';
                    document.getElementById('service-requires-electrical').checked = data.requerParteEletrica || false;
                    document.getElementById('service-status').value = data.ativo ? 'active' : 'inactive';
                }
            } catch (error) {
                console.error('Erro ao carregar servi√ßo para edi√ß√£o:', error);
                showNotification('Erro ao carregar servi√ßo.', 'error');
            }
        }

        // Fun√ß√£o para salvar servi√ßo
        async function saveService() {
            try {
                const serviceData = {
                    nome: document.getElementById('service-name').value,
                    descricao: document.getElementById('service-desc').value,
                    precoBase: parseFloat(document.getElementById('service-price').value) || 0,
                    icone: document.getElementById('service-icon').value,
                    requerEquipamento: document.getElementById('service-type').value === 'with_equipment',
                    requerParteEletrica: document.getElementById('service-requires-electrical').checked,
                    ativo: document.getElementById('service-status').value === 'active',
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!serviceData.nome) {
                    showNotification('Por favor, informe o nome do servi√ßo.', 'error');
                    return;
                }
                
                if (editingServiceId) {
                    // Atualizar servi√ßo existente
                    await db.collection('services').doc(editingServiceId).update(serviceData);
                    showNotification('Servi√ßo atualizado com sucesso!');
                } else {
                    // Criar novo servi√ßo
                    serviceData.criadoEm = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('services').add(serviceData);
                    showNotification('Servi√ßo criado com sucesso!');
                }
                
                document.getElementById('service-form').classList.add('hidden');
                loadServices();
                
            } catch (error) {
                console.error('Erro ao salvar servi√ßo:', error);
                showNotification('Erro ao salvar servi√ßo.', 'error');
            }
        }

        // Fun√ß√£o para excluir servi√ßo
        async function deleteService(serviceId) {
            if (confirm('Tem certeza que deseja excluir este servi√ßo?')) {
                try {
                    await db.collection('services').doc(serviceId).delete();
                    showNotification('Servi√ßo exclu√≠do com sucesso!');
                    loadServices();
                } catch (error) {
                    console.error('Erro ao excluir servi√ßo:', error);
                    showNotification('Erro ao excluir servi√ßo.', 'error');
                }
            }
        }

        // Carregar configura√ß√µes
        async function loadConfig() {
            try {
                const configDoc = await db.collection('configuracoes').doc('geral').get();
                
                if (configDoc.exists) {
                    const data = configDoc.data();
                    
                    document.getElementById('config-company-name').value = data.nomeEmpresa || '';
                    document.getElementById('config-whatsapp').value = data.whatsapp || '';
                    
                    if (data.btuOptions && Array.isArray(data.btuOptions)) {
                        document.getElementById('config-btu-options').value = data.btuOptions.join(', ');
                    }
                    
                    if (data.equipmentTypes && Array.isArray(data.equipmentTypes)) {
                        document.getElementById('config-equipment-types').value = data.equipmentTypes.join(', ');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }

        // Fun√ß√£o para salvar configura√ß√µes
        async function saveConfig() {
            try {
                const btuOptions = document.getElementById('config-btu-options').value
                    .split(',')
                    .map(item => item.trim())
                    .filter(item => item !== '');
                
                const equipmentTypes = document.getElementById('config-equipment-types').value
                    .split(',')
                    .map(item => item.trim())
                    .filter(item => item !== '');
                
                const configData = {
                    nomeEmpresa: document.getElementById('config-company-name').value,
                    whatsapp: document.getElementById('config-whatsapp').value,
                    btuOptions: btuOptions,
                    equipmentTypes: equipmentTypes,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('configuracoes').doc('geral').set(configData, { merge: true });
                showNotification('Configura√ß√µes salvas com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
                showNotification('Erro ao salvar configura√ß√µes.', 'error');
            }
        }

        // Adicionar eventos
        document.getElementById('btn-add-service').addEventListener('click', () => {
            editingServiceId = null;
            document.getElementById('service-form-title').textContent = 'Adicionar Novo Servi√ßo';
            document.getElementById('service-form').classList.remove('hidden');
            resetServiceForm();
        });

        document.getElementById('btn-cancel-service').addEventListener('click', () => {
            document.getElementById('service-form').classList.add('hidden');
        });

        document.getElementById('btn-save-service').addEventListener('click', saveService);
        document.getElementById('btn-save-config').addEventListener('click', saveConfig);
        document.getElementById('btn-refresh').addEventListener('click', loadDashboardData);
        document.getElementById('btn-filter').addEventListener('click', loadAllAppointments);

        // Inicializar a aplica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se h√° par√¢metros de erro na URL (para redirecionamento de login)
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            
            if (error) {
                showNotification('Por favor, fa√ßa login para acessar o painel.', 'error');
            }
        });
    </script>
</body>
</html>
